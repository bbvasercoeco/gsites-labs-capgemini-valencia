<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="TablaPaginada"
  description="Tabla cargada desde docs con paginacion y parametrizada."
  author_affiliation="Capgemini">
<Require feature="idi"/>
<Require feature="locked-domain" />
</ModulePrefs>
  
<UserPref name="_table_query_url" display_name="Data source url" required="true"/>
<UserPref name="_filaDescartadas" default_value="0" display_name="Descartar primeras n filas:" required="true"/>
<UserPref name="_Col" default_value="4" display_name="Escoger primeras n columnas:" required="true"/>
<UserPref name="_NumElemPorPagina" default_value="8" display_name="Número de elementos por página:" required="true"/>
  
<Content type="html"><![CDATA[

<script src="http://www.google.com/jsapi" type="text/javascript"></script>

<div id="tablediv" style="overflow: auto;">
<img src="http://www.google.com/ig/images/spinner.gif"/>
</div>

<style type="text/css">
   
   .tablaGeneral{
      border-collapse:collapse;
	  width:100%;
   }

   .tablaGeneral td{
      padding-left: 5px;
   }

   .cabecera{
       background: blue;
       color: white;
       font-size:18px;
       font-family:Arial;
   }

   .fila{
       background: white;
       border-bottom:solid #E2E2E2;
       height: 50px;
   }

   .filaDestacada{
      background: #F3F3F3;
      border-bottom:solid #E2E2E2;
      height: 50px;
   }

   .filaUltima{
      background: white;
      height: 50px;
      valign:center;
      text-align: right;
   }

   

</style>

<script>

var pagActual = 1;

var gadgetHelper = null;
var _filaDescartadas = 0;
var _Col = 3;
var numElePag = 8;
var totPag = 1;
var data;
_IG_RegisterOnloadHandler(loadVisualizationAPI);

	function compare(sVal1, sVal2){ 
		if (sVal1 < sVal2) return 1; 
		if (sVal1 > sVal2) return -1; 
		return 0; 
	} 

	function setDataType(cValue) { 
		var isDate = new Date(cValue); 
		if (isDate == "NaN") { 
			if (isNaN(cValue)) { 
            cValue = cValue.toUpperCase(); 
            return cValue; 
          } 
        else { 
            var myNum; 
            myNum = String.fromCharCode(48 + cValue.length) + cValue; 
            return myNum; 
          } 
        } 
  else { 
        var myDate = new String(); 
        myDate = isDate.getFullYear() + " " ; 
        myDate = myDate + isDate.getMonth() + " "; 
        myDate = myDate + isDate.getDate(); + " "; 
        myDate = myDate + isDate.getHours(); + " "; 
        myDate = myDate + isDate.getMinutes(); + " "; 
        myDate = myDate + isDate.getSeconds(); 
        //myDate = String.fromCharCode(48 + myDate.length) + myDate; 
        return myDate ; 
      } 
  } 
function sortTable(col, tableToSort) { 
    var iCurCell = col + tableToSort.cols; 
    var totalRows = tableToSort.rows.length; 
    var bSort = 0; 
    var colArray = new Array(); 
    var oldIndex = new Array(); 
    var indexArray = new Array(); 
    var bArray = new Array(); 
    var newRow; 
    var newCell; 
    var i; 
    var c; 
    var j; 
    // ** POPULATE THE ARRAY colArray WITH CONTENTS OF THE COLUMN SELECTED 
    for (i=1; i < tableToSort.rows.length; i++) 
      { 
        colArray[i - 1] = setDataType(tableToSort.cells(iCurCell).innerText); 
        iCurCell = iCurCell + tableToSort.cols; 
      } 
    // ** COPY ARRAY FOR COMPARISON AFTER SORT 
    for (i=0; i < colArray.length; i++) 
      { 
        bArray[i] = colArray[i]; 
      } 
    // ** SORT THE COLUMN ITEMS 
    //alert ( colArray ); 
    colArray.sort(compare); 
    //alert ( colArray ); 
    for (i=0; i < colArray.length; i++) 
      { // LOOP THROUGH THE NEW SORTED ARRAY 
        indexArray[i] = (i+1); 
        for(j=0; j < bArray.length; j++) 
          { // LOOP THROUGH THE OLD ARRAY 
            if (colArray[i] == bArray[j]) 
              {  // WHEN THE ITEM IN THE OLD AND NEW MATCH, PLACE THE 
                // CURRENT ROW NUMBER IN THE PROPER POSITION IN THE 
                // NEW ORDER ARRAY SO ROWS CAN BE MOVED .... 
                // MAKE SURE CURRENT ROW NUMBER IS NOT ALREADY IN THE 
                // NEW ORDER ARRAY 
                for (c=0; c<i; c++) 
                  { 
                    if ( oldIndex[c] == (j+1) ) 
                    { 
                      bSort = 1; 
                    } 
                      } 
                      if (bSort == 0) 
                        { 
                          oldIndex[i] = (j+1); 
                        } 
                          bSort = 0; 
                        } 
          } 
    } 
  // ** SORTING COMPLETE, ADD NEW ROWS TO BASE OF TABLE .... 
  for (i=0; i<oldIndex.length; i++) 
    { 
      newRow = tableToSort.insertRow(); 
      for (c=0; c<tableToSort.cols; c++) 
        { 
          newCell = newRow.insertCell(); 
          newCell.innerHTML = tableToSort.rows(oldIndex[i]).cells(c).innerHTML; 
        } 
      } 
  //MOVE NEW ROWS TO TOP OF TABLE .... 
  for (i=1; i<totalRows; i++) 
    { 
      tableToSort.moveRow((tableToSort.rows.length -1),1); 
    } 
  //DELETE THE OLD ROWS FROM THE BOTTOM OF THE TABLE .... 
  for (i=1; i<totalRows; i++) 
    { 
      tableToSort.deleteRow(); 
    } 
  } 

function loadVisualizationAPI() {
  google.load("visualization", "1");
  google.setOnLoadCallback(sendQuery);
}

function sendQuery() {
  var prefs = new _IG_Prefs(); // User preferences
  _filaDescartadas = prefs.getInt("_filaDescartadas");
  _Col = prefs.getInt("_Col");
  numElePag = prefs.getInt("_NumElemPorPagina");
  gadgetHelper = new google.visualization.GadgetHelper();
  var query = gadgetHelper.createQueryFromPrefs(prefs);
  query.send(handleQueryResponse);
}

function siguientes(){
  pagActual++;
  dibujaTabla();
}

function anteriores(){
  pagActual--;
  dibujaTabla();
}

function dibujaTabla(){
   var html = [];
   
   html.push('<table class="tablaGeneral">');
  html.push('<tr class="cabecera">');
  for (var col = 0; col < Math.min(data.getNumberOfColumns(),_Col); col++) {
    var formattedValue = data.getFormattedValue(_filaDescartadas, col);
    html.push('<td>');
       formattedValue = escapeHtml(formattedValue+'&nbsp;&nbsp;&nbsp;&nbsp;');
       html.push(formattedValue);
	   html.push('<img src="http://gsites-labs-capgemini-valencia.googlecode.com/svn/trunk/JVBtemp/img/t.png"/>');
    html.push('</td>');
  }
  html.push('</tr>');
  var inicio = ((_filaDescartadas + 1) + ((pagActual - 1) * numElePag));
  var fin = Math.min(inicio + numElePag,data.getNumberOfRows());
  for (var row = inicio; row < fin; row++) {
    if((row % 2) == 0)
       html.push('<tr class="filaDestacada">');
    else
       html.push('<tr class="fila">');
      
    for (var col = 0; col < Math.min(data.getNumberOfColumns(),_Col); col++) {

      var formattedValue = data.getFormattedValue(row, col);
      formattedValue = escapeHtml(formattedValue);

        //html.push('<span style="color:red; font-size:24pt; font-weight:bold;">');
        html.push('<td>');
           html.push(formattedValue);
        html.push('</td>');
    }
    html.push('</tr>');
  }
  html.push('<tr class="filaUltima"><td colspan="'+_Col +'">');
  if(data.getNumberOfRows() > numElePag){
     if(pagActual > 1){
	    html.push('<a href="#" onclick="anteriores();"><< Anteriores</a>&nbsp;|&nbsp;');
     }
     html.push('P&aacute;gina '+pagActual+' de '+totPag);
     if(pagActual < totPag){
        html.push(' | <a href="#" onclick="siguientes();">Siguientes >></a>');
     }
  }

  html.push('</td></tr></table>');
  var tableDiv = _gel('tablediv');
  tableDiv.innerHTML = html.join('');
  tableDiv.style.width = document.body.clientWidth + 'px';
  tableDiv.style.height = document.body.clientHeight + 'px';
}

function handleQueryResponse(response) {
  if (!gadgetHelper.validateResponse(response)) { return; }
  data = response.getDataTable();
  
  totPag = Math.ceil(data.getNumberOfRows() / numElePag);
  dibujaTabla();
}

function escapeHtml(text) {
  if (text == null) {
    return '';
  }
  return _hesc(text);
}

</script>
]]>
</Content>
</Module>